<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particle Physics</title>

    <script src="https://twgljs.org/dist/6.x/twgl-full.min.js"></script>
</head>

<body>
    <h1>Particle Physics</h1>
    <p>A simplified implementation of Jakobsen's Advanced Character Physics.</p>

    <canvas id="canvas" width="600" height="600" style="border: 1px solid black;"></canvas>

    <script id="vs" type="x-shader/x-vertex">
        attribute vec2 a_position;

        uniform vec2 u_resolution;

        void main() {
            // convert the position from pixels to 0.0 to 1.0
            vec2 zeroToOne = a_position / u_resolution;
        
            // convert from 0->1 to 0->2
            vec2 zeroToTwo = zeroToOne * 2.0;
        
            // convert from 0->2 to -1->+1 (clip space)
            vec2 clipSpace = zeroToTwo - 1.0;
        
            gl_Position = vec4(clipSpace * vec2(1,-1), 0, 1);
            gl_PointSize = 5.0;
        }
    </script>
    <script id="fs" type="x-shader/x-fragment">
        precision mediump float;

        // uniform sampler2D u_texture;
        uniform vec4 u_color;

        void main() {
            gl_FragColor = u_color;
        }
    </script>

    <script type="module">
        import Body from "./Body.js"
        import Particle from "./Particle.js"
        import LinearConstraint from "./LinearConstraint.js"
        import AngularContraint from "./AngularConstraint.js"

        const gl = document.getElementById('canvas').getContext('webgl');
        const startTime = Date.now()

        let dragged = false
        let sel = null

        let bodies = [];
        let body1 = trelis(twgl.v3.create(100, 200), twgl.v3.create(100, 100), 4, 4, true, true)
        body1.particles[0].pinned = true

        let body2 = trelis(twgl.v3.create(400, 250), twgl.v3.create(100, 100), 8, 8)
        body2.particles[0].pinned = true
        body2.particles[8].pinned = true

        // Simple stick
        let p1 = new Particle(gl, twgl.v3.create(400, 200))
        let p2 = new Particle(gl, twgl.v3.create(500, 200))
        let body3 = new Body(gl, [p1, p2], [new LinearConstraint(gl, p1, p2)])
        body3.particles[1].pinned = true

        let articulateBody = articulatedBody()
        bodies.push(body1, body2, body3, ...articulateBody);

        let lastTime = Date.now() - startTime
        function loop(time) {
            // Physics
            const deltaTime = (time - lastTime) / 1000
            lastTime = time;

            for (const body of bodies) {
                body.update(deltaTime);
            }

            // Rendering
            twgl.resizeCanvasToDisplaySize(gl.canvas);
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

            for (const body of bodies) {
                body.draw();
            }

            requestAnimationFrame(loop)
        }
        requestAnimationFrame(loop)

        function trelis(corner, size, nx, ny, stiff, reinforce) {
            let particles = []
            let constraints = []

            let dx = twgl.v3.create(size[0] / nx, 0)
            let dy = twgl.v3.create(0, size[1] / ny)

            let m = nx + 1;
            for (let i = 0; i <= ny; i++) {
                let q = twgl.v3.add(corner, twgl.v3.mulScalar(dy, i));
                for (let j = 0; j <= nx; j++) {
                    let p = twgl.v3.add(q, twgl.v3.mulScalar(dx, j));
                    particles.push(new Particle(gl, p));

                    let k = i * m + j;
                    if (j > 0)
                        constraints.push(new LinearConstraint(gl, particles[k], particles[k - 1]));
                    if (i > 0)
                        constraints.push(new LinearConstraint(gl, particles[k], particles[k - m]));
                    if (i > 0 && j > 0 && stiff) {
                        constraints.push(
                            new LinearConstraint(gl, particles[k - 1], particles[k - m]),
                            new LinearConstraint(gl, particles[k], particles[k - m - 1])
                        );
                    }
                }
            }

            if (nx > 1 && ny > 1 && reinforce) {
                constraints.push(
                    new LinearConstraint(gl, particles[0], particles[particles.length - 1]),
                    new LinearConstraint(gl, particles[0], particles[m - 1]),
                    new LinearConstraint(gl, particles[0], particles[particles.length - m]),
                    new LinearConstraint(gl, particles[particles.length - m], particles[m - 1]),
                    new LinearConstraint(gl, particles[m - 1], particles[particles.length - 1]),
                    new LinearConstraint(gl, particles[particles.length - m], particles[particles.length - 1])
                );
            }

            return new Body(gl, particles, constraints)
        }

        function articulatedBody() {
            let p1 = new Particle(gl, twgl.v3.create(200, 200))
            let p2 = new Particle(gl, twgl.v3.create(250, 200))
            let p3 = new Particle(gl, twgl.v3.create(200, 250))
            let p4 = new Particle(gl, twgl.v3.create(250, 250))
            p2.pinned = true
            let contraint1 = new LinearConstraint(gl, p1, p2)
            let contraint5 = new LinearConstraint(gl, p1, p3)
            let contraint3 = new LinearConstraint(gl, p3, p4)
            let contraint6 = new LinearConstraint(gl, p2, p4)
            let contraint2 = new LinearConstraint(gl, p2, p3)
            let contraint4 = new LinearConstraint(gl, p4, p1)
            let body1 = new Body(gl, [p1, p2, p3, p4], [contraint1, contraint2, contraint3, contraint4, contraint5, contraint6])

            let p5 = new Particle(gl, twgl.v3.create(300, 200))
            let p6 = new Particle(gl, twgl.v3.create(350, 250))
            let contraint7 = new LinearConstraint(gl, p5, p2)
            let contraint8 = new LinearConstraint(gl, p5, p6)
            let contraint9 = new LinearConstraint(gl, p6, p2)
            let contraint10 = new AngularContraint(gl, p5, p4)
            let body2 = new Body(gl, [p2, p5, p6], [contraint7, contraint8, contraint9, contraint10])

            return [body1, body2]
        }

        window.addEventListener("mousedown", (e) => {
            const rect = gl.canvas.getBoundingClientRect();
            let mousePosition = twgl.v3.create(e.clientX - rect.left, e.clientY - rect.top)

            let closest = null
            let closestDistance = 20

            console.log(e.button)
            if (e.button === 0) { // pin/unpin particle on mouse left button
                for (const body of bodies) {
                    for (const particle of body.particles) {
                        let d = twgl.v3.distance(particle.position, mousePosition)
                        if (d < closestDistance) {
                            closest = particle
                            closestDistance = d
                        }
                    }
                }
            } else if (e.button === 2) { // destroy a constraint on mouse right button
                for (const body of bodies) {
                    for (const constraint of body.constraints) {
                        let line = twgl.v3.subtract(constraint.p1.position, constraint.p0.position)
                        let p0_m = twgl.v3.subtract(mousePosition, constraint.p0.position)

                        let projx = twgl.v3.dot(line, p0_m) / twgl.v3.dot(line, line)
                        let proj = twgl.v3.mulScalar(line, projx)
                        let perp = twgl.v3.subtract(p0_m, proj)
                        let distance = twgl.v3.length(perp)

                        if (distance < closestDistance) {
                            closest = constraint
                            closestDistance = distance
                        }
                    }
                }
            }

            if (closest) {
                if (closest instanceof Particle) {
                    closest.pinned = !closest.pinned
                }
                if (closest instanceof LinearConstraint) {
                    closest.isActive = false
                }
                sel = closest
            }
        })

        window.addEventListener("contextmenu", (e) => e.preventDefault())
        // window.addEventListener("pointerup", (e) => {
        // })
    </script>
</body>

</html>